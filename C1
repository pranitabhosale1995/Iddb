import React, { useState, useCallback, useEffect } from 'react';
import { 
  TextField, Button, Box, Container, Paper, Typography, 
  IconButton, Grid, Card, CardContent, Divider,
  Dialog, DialogTitle, DialogContent, DialogActions
} from '@mui/material';
import { DataGrid } from '@mui/x-data-grid';
import HistoryIcon from '@mui/icons-material/History';
import CloseIcon from '@mui/icons-material/Close';

const BalanceParticularSearchScreen = () => {
  const [filters, setFilters] = useState({ date: '', branchCode: '01063', currency: 'INR', cgl: '' });
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(false);
  const [totalElements, setTotalElements] = useState(0);
  const [paginationModel, setPaginationModel] = useState({ page: 0, pageSize: 10 });
  
  const [openHistory, setOpenHistory] = useState(false);
  const [selectedRow, setSelectedRow] = useState(null);

  const updateFilter = (key, value) => setFilters(prev => ({ ...prev, [key]: value }));

  // API Call logic stays the same (POST method as fixed earlier)
  const fetchData = useCallback(async (date, pageIndex, pageSize) => {
    if (!date) return;
    setLoading(true);
    try {
      const payload = { fromDate: date, toDate: date, branchCode: filters.branchCode, currency: filters.currency, cgl: filters.cgl || null };
      const response = await callApi(`/api/differences/search?page=${pageIndex}&size=${pageSize}`, payload, "POST");
      const content = response?.data?.content || response?.content || [];
      const mappedRows = content.map((item, index) => ({
        id: item.id || `row-${index}`,
        ...item,
        GLCC_VAL: `${item.branchCode} ${item.currency} ${item.cgl}`
      }));
      setRows(mappedRows);
      setTotalElements(response?.data?.totalElements || 0);
    } catch (err) { console.error(err); }
    finally { setLoading(false); }
  }, [filters]);

  useEffect(() => {
    if (filters.date) fetchData(filters.date, paginationModel.page, paginationModel.pageSize);
  }, [paginationModel.page, paginationModel.pageSize]);

  const columns = [
    { field: 'reconRunDate', headerName: 'Error Date', width: 120 },
    { field: 'GLCC_VAL', headerName: 'GLCC', width: 220 },
    { field: 'cbsBalance', headerName: 'CBS Balance', width: 130, align: 'right' },
    { field: 'glBalance', headerName: 'GL Balance', width: 130, align: 'right' },
    { field: 'differenceAmount', headerName: 'Difference', width: 140, align: 'right',
      renderCell: (params) => (
        <Typography sx={{ color: params.value < 0 ? '#d32f2f' : '#2e7d32', fontWeight: 700 }}>
          {params.value?.toLocaleString()}
        </Typography>
      )
    },
    {
      field: 'action', headerName: 'Action', width: 80, sortable: false,
      renderCell: (params) => (
        <IconButton color="primary" onClick={() => { setSelectedRow(params.row); setOpenHistory(true); }}>
          <HistoryIcon />
        </IconButton>
      ),
    },
  ];

  return (
    <Container maxWidth="xl" sx={{ mt: 4 }}>
      {/* Search Section */}
      <Card sx={{ borderRadius: 3, mb: 4, boxShadow: '0 4px 12px rgba(0,0,0,0.05)' }}>
        <CardContent sx={{ p: 3 }}>
          <Grid container spacing={2} alignItems="center">
            <Grid item xs={12} md={3}>
              <TextField fullWidth label="Select Date" type="date" size="small" value={filters.date}
                onChange={(e) => updateFilter('date', e.target.value)} InputLabelProps={{ shrink: true }} />
            </Grid>
            <Grid item xs={12} md={2}>
              <Button fullWidth variant="contained" sx={{ height: 40, bgcolor: '#1a237e' }} onClick={() => fetchData(filters.date, 0, 10)}>
                Search
              </Button>
            </Grid>
          </Grid>
        </CardContent>
      </Card>

      <Paper sx={{ height: 500, width: '100%', borderRadius: 4, overflow: 'hidden' }}>
        <DataGrid rows={rows} columns={columns} rowCount={totalElements} loading={loading}
          paginationMode="server" paginationModel={paginationModel} onPaginationModelChange={setPaginationModel}
          pageSizeOptions={[10, 25, 50]} />
      </Paper>

      {/* Modern Dialog UI - Based on your uploaded reference */}
      <Dialog 
        open={openHistory} 
        onClose={() => setOpenHistory(false)}
        maxWidth="md"
        fullWidth
        PaperProps={{ sx: { borderRadius: 4, p: 1 } }}
      >
        <DialogTitle sx={{ m: 0, p: 2, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <Typography variant="h6" sx={{ fontWeight: 700, color: '#374151' }}>
            Difference Details - ID: {selectedRow?.id?.toString().split('-').pop()}
          </Typography>
          <IconButton onClick={() => setOpenHistory(false)}><CloseIcon /></IconButton>
        </DialogTitle>

        <DialogContent dividers sx={{ border: 'none' }}>
          {selectedRow && (
            <Box sx={{ py: 2 }}>
              {/* Row 1: Main Info */}
              <Grid container spacing={4} sx={{ mb: 4 }}>
                <Grid item xs={3}>
                  <Typography variant="caption" color="text.secondary" sx={{ fontWeight: 600 }}>BRANCH CODE</Typography>
                  <Typography variant="body1" sx={{ fontWeight: 500, mt: 0.5 }}>{selectedRow.branchCode}</Typography>
                </Grid>
                <Grid item xs={3}>
                  <Typography variant="caption" color="text.secondary" sx={{ fontWeight: 600 }}>CURRENCY</Typography>
                  <Typography variant="body1" sx={{ fontWeight: 500, mt: 0.5 }}>{selectedRow.currency}</Typography>
                </Grid>
                <Grid item xs={3}>
                  <Typography variant="caption" color="text.secondary" sx={{ fontWeight: 600 }}>GLCC COMBINATION</Typography>
                  <Typography variant="body1" sx={{ fontWeight: 500, mt: 0.5 }}>{selectedRow.GLCC_VAL}</Typography>
                </Grid>
                <Grid item xs={3}>
                  <Typography variant="caption" color="text.secondary" sx={{ fontWeight: 600 }}>RECON DATE</Typography>
                  <Typography variant="body1" sx={{ fontWeight: 500, mt: 0.5 }}>{selectedRow.reconRunDate}</Typography>
                </Grid>
              </Grid>

              {/* Row 2: Balances */}
              <Grid container spacing={4} sx={{ mb: 2 }}>
                <Grid item xs={3}>
                  <Typography variant="caption" color="text.secondary" sx={{ fontWeight: 600 }}>CBS BALANCE</Typography>
                  <Typography variant="body1" sx={{ mt: 0.5 }}>{selectedRow.cbsBalance?.toLocaleString()}</Typography>
                </Grid>
                <Grid item xs={3}>
                  <Typography variant="caption" color="text.secondary" sx={{ fontWeight: 600 }}>GL BALANCE</Typography>
                  <Typography variant="body1" sx={{ mt: 0.5 }}>{selectedRow.glBalance?.toLocaleString()}</Typography>
                </Grid>
                <Grid item xs={6}>
                  <Typography variant="caption" color="text.secondary" sx={{ fontWeight: 600 }}>HEAD / TYPE</Typography>
                  <Typography variant="body1" sx={{ mt: 0.5, fontStyle: 'italic', color: '#1a237e' }}>
                    {selectedRow.head} | {selectedRow.type}
                  </Typography>
                </Grid>
              </Grid>
              
              <Divider sx={{ my: 3 }} />

              {/* Bottom Large Amount Display */}
              <Box display="flex" justifyContent="space-between" alignItems="center">
                <Box>
                  <Typography variant="caption" color="text.secondary" sx={{ fontWeight: 600 }}>YESTERDAY DIFFERENCE</Typography>
                  <Typography variant="h6">{selectedRow.diffBwYesterday?.toLocaleString()}</Typography>
                </Box>
                <Box sx={{ textAlign: 'right' }}>
                  <Typography variant="caption" color="text.secondary" sx={{ fontWeight: 600 }}>TOTAL DIFFERENCE AMOUNT</Typography>
                  <Typography variant="h5" sx={{ fontWeight: 800, color: selectedRow.differenceAmount < 0 ? '#d32f2f' : '#2e7d32' }}>
                    {selectedRow.differenceAmount?.toLocaleString()}
                  </Typography>
                </Box>
              </Box>
            </Box>
          )}
        </DialogContent>

        <DialogActions sx={{ p: 3 }}>
          <Button 
            onClick={() => setOpenHistory(false)} 
            variant="contained" 
            sx={{ borderRadius: 3, px: 4, bgcolor: '#1a237e', textTransform: 'none' }}
          >
            Close
          </Button>
        </DialogActions>
      </Dialog>
    </Container>
  );
};

export default BalanceParticularSearchScreen;
