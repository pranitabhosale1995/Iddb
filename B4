import React, { useState, useCallback, useEffect } from 'react';
import { 
  TextField, Button, Box, Container, Paper, 
  Typography, Modal, IconButton, Grid, InputAdornment, Card, CardContent 
} from '@mui/material';
import { DataGrid } from '@mui/x-data-grid';
import HistoryIcon from '@mui/icons-material/History';
import CalendarMonthIcon from '@mui/icons-material/CalendarMonth';
import CloseIcon from '@mui/icons-material/Close';

const modalStyle = {
  position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)',
  width: 550, bgcolor: 'background.paper', boxShadow: 24, p: 0, borderRadius: 3, overflow: 'hidden'
};

const BalanceParticularSearchScreen = () => {
  const [reportDate, setReportDate] = useState('');
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(false);
  const [totalElements, setTotalElements] = useState(0);
  const [paginationModel, setPaginationModel] = useState({ page: 0, pageSize: 100 });
  const [openHistory, setOpenHistory] = useState(false);
  const [selectedRow, setSelectedRow] = useState(null);

  // 1. Initial Load: Fetch Default ETL Date
  useEffect(() => {
    const fetchDefaultDate = async () => {
      try {
        const response = await callApi('/api/fincoredate', {}, "GET");
        // Samja response { date: '2025-11-21' } asha format madhe ahe
        const defaultDate = response?.date || response?.data?.date || '';
        setReportDate(defaultDate);
        if (defaultDate) {
          fetchData(defaultDate, 0);
        }
      } catch (err) {
        console.error("Error fetching ETL date:", err);
      }
    };
    fetchDefaultDate();
  }, []);

  // 2. Main Search Function (POST Method with Search Endpoint)
  const fetchData = useCallback(async (date, pageIndex) => {
    if (!date) return;
    setLoading(true);

    const payload = {
      fromDate: date,
      toDate: date,
      branchCode: "01063",
      currency: "INR",
      cgl: null
    };

    try {
      const response = await callApi(`/api/differences/search?page=${pageIndex}&size=100`, payload, "POST");
      const content = response?.data?.content || response?.content || [];
      
      if (Array.isArray(content)) {
        const mappedRows = content.map((item, index) => ({
          id: item.id || `row-${pageIndex}-${index}`,
          ERROR_DATE: item.first_ERROR_DATE || '-',
          GLCC_VAL: `${item.branchCode || ''} ${item.currency || ''} ${item.cgl || ''}`,
          CBS_BALANCE: item.cbsBalance ?? 0,
          GL_BALANCE: item.glBalance ?? 0,
          DIFFERENCE_AMOUNT: item.differenceAmount ?? 0,
          DIFF_YESTERDAY: item.diffBwYesterday ?? 0,
          TYPE_VAL: item.type || '-',
          HEAD_VAL: item.head || '-',
        }));
        setRows(mappedRows);
        setTotalElements(response?.data?.totalElements || response?.totalElements || 0);
      }
    } catch (err) {
      console.error("Search Error:", err);
      setRows([]);
    } finally {
      setLoading(false);
    }
  }, []);

  // Handle pagination change
  useEffect(() => {
    if (reportDate) {
      fetchData(reportDate, paginationModel.page);
    }
  }, [paginationModel.page]);

  const columns = [
    { field: 'ERROR_DATE', headerName: 'Error Date', width: 120 },
    { field: 'GLCC_VAL', headerName: 'GLCC', width: 220 },
    { field: 'CBS_BALANCE', headerName: 'CBS Balance', width: 130, align: 'right' },
    { field: 'GL_BALANCE', headerName: 'GL Balance', width: 130, align: 'right' },
    { 
      field: 'DIFFERENCE_AMOUNT', 
      headerName: 'Difference', 
      width: 140, 
      align: 'right',
      renderCell: (params) => (
        <Typography sx={{ color: params.value < 0 ? 'error.main' : 'success.main', fontWeight: 700 }}>
          {params.value.toLocaleString()}
        </Typography>
      )
    },
    { field: 'HEAD_VAL', headerName: 'Head', width: 130 },
    {
      field: 'action',
      headerName: 'Action',
      width: 90,
      renderCell: (params) => (
        <IconButton color="primary" onClick={() => { setSelectedRow(params.row); setOpenHistory(true); }}>
          <HistoryIcon />
        </IconButton>
      ),
    },
  ];

  return (
    <Container maxWidth="xl" sx={{ mt: 4 }}>
      <Typography variant="h5" sx={{ mb: 3, fontWeight: 700, color: '#1a237e' }}>
        Particular Day Reconciliation
      </Typography>

      <Card sx={{ borderRadius: 3, mb: 4, boxShadow: '0 4px 20px rgba(0,0,0,0.08)' }}>
        <CardContent sx={{ p: 3 }}>
          <Box display="flex" alignItems="center" gap={3}>
            <TextField 
              label="ETL Date"
              type="date"
              size="small"
              value={reportDate}
              onChange={(e) => setReportDate(e.target.value)}
              InputLabelProps={{ shrink: true }}
              InputProps={{ startAdornment: <InputAdornment position="start"><CalendarMonthIcon /></InputAdornment> }}
              sx={{ width: 250 }}
            />
            <Button 
              variant="contained" 
              onClick={() => { setPaginationModel({ page: 0, pageSize: 100 }); fetchData(reportDate, 0); }}
              sx={{ height: 40, px: 4, borderRadius: 2, textTransform: 'none', fontWeight: 600 }}
            >
              Search
            </Button>
          </Box>
        </CardContent>
      </Card>

      <Paper sx={{ height: 600, width: '100%', borderRadius: 3, overflow: 'hidden' }}>
        <DataGrid
          rows={rows}
          columns={columns}
          rowCount={totalElements}
          loading={loading}
          paginationMode="server"
          paginationModel={paginationModel}
          onPaginationModelChange={setPaginationModel}
          pageSizeOptions={[100]}
          disableSelectionOnClick
        />
      </Paper>

      {/* History Popup */}
      <Modal open={openHistory} onClose={() => setOpenHistory(false)}>
        <Box sx={modalStyle}>
          <Box sx={{ bgcolor: '#1a237e', p: 2, color: 'white', display: 'flex', justifyContent: 'space-between' }}>
            <Typography variant="h6">Record Details</Typography>
            <IconButton onClick={() => setOpenHistory(false)} sx={{ color: 'white' }}><CloseIcon /></IconButton>
          </Box>
          <Box sx={{ p: 3 }}>
            {selectedRow && (
              <Box>
                <Typography variant="caption">GLCC</Typography>
                <Typography variant="body1" sx={{ fontWeight: 600 }}>{selectedRow.GLCC_VAL}</Typography>
                <Typography variant="caption" sx={{ mt: 2, display: 'block' }}>DIFFERENCE</Typography>
                <Typography variant="h6" color="error.main">{selectedRow.DIFFERENCE_AMOUNT}</Typography>
              </Box>
            )}
            <Button fullWidth variant="contained" sx={{ mt: 3 }} onClick={() => setOpenHistory(false)}>Close</Button>
          </Box>
        </Box>
      </Modal>
    </Container>
  );
};

export default BalanceParticularSearchScreen;
