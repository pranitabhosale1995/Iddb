import React, { useState, useCallback, useEffect } from 'react';
import { 
  TextField, Button, Box, Container, Paper, 
  Typography, Modal, IconButton, Grid 
} from '@mui/material';
import { DataGrid } from '@mui/x-data-grid';
import HistoryIcon from '@mui/icons-material/History';

// Modal style for the History Popup
const modalStyle = {
  position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)',
  width: 500, bgcolor: 'background.paper', boxShadow: 24, p: 4, borderRadius: 2,
};

const BalanceRangeSearchScreen = () => {
  // State for search filters
  const [filters, setFilters] = useState({
    startDate: '',
    endDate: '',
    glcc: ''
  });

  // State for data and table visibility
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(false);
  const [showTable, setShowTable] = useState(false); // Controls table visibility
  const [totalElements, setTotalElements] = useState(0);
  const [paginationModel, setPaginationModel] = useState({ page: 0, pageSize: 100 });

  // History Popup state
  const [openHistory, setOpenHistory] = useState(false);
  const [selectedRow, setSelectedRow] = useState(null);

  const updateFilter = (key, value) => setFilters(prev => ({ ...prev, [key]: value }));

  /**
   * Main Fetch Function using callApi logic from your screenshot
   */
  const fetchDifferences = useCallback(async (pageIndex) => {
    // Basic validation: Dates are required for range search
    if (!filters.startDate || !filters.endDate) {
      alert("Please select both Start and End dates.");
      return;
    }

    setLoading(true);
    setShowTable(true); // Show table area once search is triggered

    try {
      const response = await callApi('/RS/differences', {
        params: { 
          page: pageIndex, 
          size: 100, 
          reportDate: filters.startDate, // Adjust backend params if it supports fromDate/toDate
          toDate: filters.endDate,
          glccFilter: filters.glcc 
        }
      }, "GET");

      const content = response?.data?.content || response?.content || [];
      
      if (Array.isArray(content)) {
        const mappedRows = content.map((item, index) => ({
          id: item.id || `row-${pageIndex}-${index}`,
          ERROR_DATE: item.first_ERROR_DATE || '-',
          REPORT_DATE: item.reconRunDate || '-',
          GLCC_VAL: `${item.branchCode || ''} ${item.currency || ''} ${item.cgl || ''}`,
          CBS_BALANCE: item.cbsBalance ?? 0,
          GL_BALANCE: item.glBalance ?? 0,
          DIFFERENCE_AMOUNT: item.differenceAmount ?? 0,
          DIFF_YESTERDAY: item.diffBwYesterday ?? 0,
          TYPE_VAL: item.type || '-',
          HEAD_VAL: item.head || '-',
        }));
        
        setRows(mappedRows);
        setTotalElements(response?.data?.totalElements || response?.totalElements || 0);
      }
    } catch (err) {
      console.error("Fetch Error:", err);
    } finally {
      setLoading(false);
    }
  }, [filters, paginationModel.pageSize]);

  // Handle page change in DataGrid
  useEffect(() => {
    if (showTable) {
      fetchDifferences(paginationModel.page);
    }
  }, [paginationModel.page]);

  const columns = [
    { field: 'ERROR_DATE', headerName: 'Error Date', width: 120 },
    { field: 'GLCC_VAL', headerName: 'GLCC', width: 220 },
    { field: 'CBS_BALANCE', headerName: 'CBS Balance', width: 130 },
    { field: 'GL_BALANCE', headerName: 'GL Balance', width: 130 },
    { field: 'DIFFERENCE_AMOUNT', headerName: 'Difference', width: 130 },
    { field: 'DIFF_YESTERDAY', headerName: 'Yesterday Diff', width: 150 },
    { field: 'TYPE_VAL', headerName: 'Type', width: 120 },
    { field: 'HEAD_VAL', headerName: 'Head', width: 130 },
    {
      field: 'action',
      headerName: 'Action',
      width: 100,
      renderCell: (params) => (
        <IconButton color="primary" onClick={() => { setSelectedRow(params.row); setOpenHistory(true); }}>
          <HistoryIcon />
        </IconButton>
      ),
    },
  ];

  return (
    <Container maxWidth="xl" sx={{ mt: 4 }}>
      <Typography variant="h5" sx={{ mb: 3 }}>Difference Range Search</Typography>

      {/* Filter Section */}
      <Paper sx={{ p: 3, mb: 3 }}>
        <Grid container spacing={2} alignItems="center">
          <Grid item xs={12} md={3}>
            <TextField
              fullWidth
              label="Start Date"
              type="date"
              InputLabelProps={{ shrink: true }}
              value={filters.startDate}
              onChange={(e) => updateFilter('startDate', e.target.value)}
            />
          </Grid>
          <Grid item xs={12} md={3}>
            <TextField
              fullWidth
              label="End Date"
              type="date"
              InputLabelProps={{ shrink: true }}
              value={filters.endDate}
              onChange={(e) => updateFilter('endDate', e.target.value)}
            />
          </Grid>
          <Grid item xs={12} md={4}>
            <TextField
              fullWidth
              label="Search GLCC (Br-Cur-CGL)"
              placeholder="e.g. 01063-INR-2028..."
              value={filters.glcc}
              onChange={(e) => updateFilter('glcc', e.target.value)}
            />
          </Grid>
          <Grid item xs={12} md={2}>
            <Button 
              fullWidth 
              variant="contained" 
              size="large"
              onClick={() => {
                setPaginationModel({ page: 0, pageSize: 100 });
                fetchDifferences(0);
              }}
            >
              Search
            </Button>
          </Grid>
        </Grid>
      </Paper>

      {/* Results Table - Only visible after search */}
      {showTable && (
        <Paper sx={{ height: 600, width: '100%' }}>
          <DataGrid
            rows={rows}
            columns={columns}
            rowCount={totalElements}
            loading={loading}
            paginationMode="server"
            paginationModel={paginationModel}
            onPaginationModelChange={setPaginationModel}
            pageSizeOptions={[100]}
            disableSelectionOnClick
          />
        </Paper>
      )}

      {/* History Modal */}
      <Modal open={openHistory} onClose={() => setOpenHistory(false)}>
        <Box sx={modalStyle}>
          <Typography variant="h6" sx={{ mb: 2 }}>Record Details</Typography>
          {selectedRow && (
            <Box>
              <Typography><b>GLCC:</b> {selectedRow.GLCC_VAL}</Typography>
              <Typography sx={{ mt: 1 }}><b>Head:</b> {selectedRow.HEAD_VAL}</Typography>
              <Typography sx={{ mt: 1 }}><b>Yesterday Diff:</b> {selectedRow.DIFF_YESTERDAY}</Typography>
              <Button sx={{ mt: 3 }} fullWidth variant="outlined" onClick={() => setOpenHistory(false)}>Close</Button>
            </Box>
          )}
        </Box>
      </Modal>
    </Container>
  );
};

export default BalanceRangeSearchScreen;
