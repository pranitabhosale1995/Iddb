import React, { useState, useEffect, useCallback } from 'react';
import { TextField, Button, Box, Container, Paper, Typography, Modal, IconButton } from '@mui/material';
import { DataGrid } from '@mui/x-data-grid';
import HistoryIcon from '@mui/icons-material/History';
// Import your callApi helper here
// import { callApi } from './apiHelper'; 

const modalStyle = {
  position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)',
  width: 500, bgcolor: 'background.paper', boxShadow: 24, p: 4, borderRadius: 2,
};

const BalanceCompareDifferenceScreen = () => {
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(false);
  const [reportDate, setReportDate] = useState(''); // Selected date
  const [totalElements, setTotalElements] = useState(0);
  const [paginationModel, setPaginationModel] = useState({ page: 0, pageSize: 100 });
  
  const [openHistory, setOpenHistory] = useState(false);
  const [selectedRow, setSelectedRow] = useState(null);

  // 1. Fetch initial fincore date (Mocking the callApi usage)
  useEffect(() => {
    const getInitialDate = async () => {
      try {
        const res = await callApi('/api/fincoredate', {}, "GET");
        if (res?.date) {
          setReportDate(res.date);
          fetchDifferences(res.date, 0);
        }
      } catch (err) { console.error(err); }
    };
    getInitialDate();
  }, []);

  // 2. Fetch data using the callApi function from your screenshot
  const fetchDifferences = useCallback(async (date, pageIndex) => {
    if (!date) return;
    setLoading(true);

    try {
      // Matching the logic from your screenshot
      const response = await callApi('/RS/differences', {
        params: { 
          page: pageIndex, 
          size: 100, 
          reportDate: date, 
          glccFilter: '' // Add your filter if needed
        }
      }, "GET");

      const content = response?.data?.content || response?.content || [];
      
      if (Array.isArray(content)) {
        const mappedRows = content.map((item, index) => ({
          id: item.id || `row-${index}`,
          ERROR_DATE: item.first_ERROR_DATE || '-',
          REPORT_DATE: item.reconRunDate || '-',
          // Concatenating Branch, Currency and CGL as shown in your screenshot
          GLCC_VAL: `${item.branchCode || ''} ${item.currency || ''} ${item.cgl || ''}`,
          CBS_BALANCE: item.cbsBalance ?? 0,
          GL_BALANCE: item.glBalance ?? 0,
          DIFFERENCE_AMOUNT: item.differenceAmount ?? 0,
          DIFF_YESTERDAY: item.diffBwYesterday ?? 0,
          TYPE_VAL: item.type || '-',
          HEAD_VAL: item.head || '-',
        }));
        
        setRows(mappedRows);
        setTotalElements(response?.data?.totalElements || response?.totalElements || 0);
      }
    } catch (err) {
      console.error("API Error:", err);
    } finally {
      setLoading(false);
    }
  }, [paginationModel.pageSize]);

  // Trigger fetch when page changes
  useEffect(() => {
    fetchDifferences(reportDate, paginationModel.page);
  }, [paginationModel.page, fetchDifferences]);

  const columns = [
    { field: 'ERROR_DATE', headerName: 'Error Date', width: 120 },
    { field: 'GLCC_VAL', headerName: 'GLCC (Br-Cur-CGL)', width: 220 },
    { field: 'CBS_BALANCE', headerName: 'CBS Balance', width: 130 },
    { field: 'GL_BALANCE', headerName: 'GL Balance', width: 130 },
    { field: 'DIFFERENCE_AMOUNT', headerName: 'Difference', width: 130 },
    { field: 'DIFF_YESTERDAY', headerName: 'Diff Yesterday', width: 150 },
    { field: 'TYPE_VAL', headerName: 'Type', width: 120 },
    { field: 'HEAD_VAL', headerName: 'Head', width: 130 },
    {
      field: 'action',
      headerName: 'Action',
      width: 100,
      renderCell: (params) => (
        <IconButton color="primary" onClick={() => { setSelectedRow(params.row); setOpenHistory(true); }}>
          <HistoryIcon />
        </IconButton>
      ),
    },
  ];

  return (
    <Container maxWidth="xl" sx={{ mt: 4 }}>
      <Paper sx={{ p: 3, mb: 3 }}>
        <Box display="flex" gap={2} alignItems="center">
          <TextField
            label="Report Date"
            type="date"
            value={reportDate}
            onChange={(e) => setReportDate(e.target.value)}
            InputLabelProps={{ shrink: true }}
          />
          <Button variant="contained" onClick={() => fetchDifferences(reportDate, 0)}>Search</Button>
        </Box>
      </Paper>

      <Paper sx={{ height: 600, width: '100%' }}>
        <DataGrid
          rows={rows}
          columns={columns}
          rowCount={totalElements}
          loading={loading}
          paginationMode="server"
          paginationModel={paginationModel}
          onPaginationModelChange={setPaginationModel}
          pageSizeOptions={[100]}
        />
      </Paper>

      {/* History Modal */}
      <Modal open={openHistory} onClose={() => setOpenHistory(false)}>
        <Box sx={modalStyle}>
          <Typography variant="h6">Difference History</Typography>
          {selectedRow && (
            <Box sx={{ mt: 2 }}>
              <Typography><b>GLCC:</b> {selectedRow.GLCC_VAL}</Typography>
              <Typography><b>Difference:</b> {selectedRow.DIFFERENCE_AMOUNT}</Typography>
              <Typography><b>Yesterday:</b> {selectedRow.DIFF_YESTERDAY}</Typography>
              <Button sx={{ mt: 2 }} fullWidth variant="outlined" onClick={() => setOpenHistory(false)}>Close</Button>
            </Box>
          )}
        </Box>
      </Modal>
    </Container>
  );
};

export default BalanceCompareDifferenceScreen;
