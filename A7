import React, { useState, useCallback, useEffect } from 'react';
import { 
  TextField, Button, Box, Container, Paper, 
  Typography, Modal, IconButton, Grid, Divider,
  InputAdornment, Card, CardContent
} from '@mui/material';
import { DataGrid } from '@mui/x-data-grid';
import HistoryIcon from '@mui/icons-material/History';
import CalendarMonthIcon from '@mui/icons-material/CalendarMonth';
import SearchIcon from '@mui/icons-material/Search';
import CloseIcon from '@mui/icons-material/Close';

const modalStyle = {
  position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)',
  width: 550, bgcolor: 'background.paper', boxShadow: "0px 10px 30px rgba(0,0,0,0.2)", 
  p: 0, borderRadius: 3, overflow: 'hidden'
};

const BalanceRangeSearchScreen = () => {
  const [filters, setFilters] = useState({
    fromDate: '',
    toDate: '',
    glcc: ''
  });

  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(false);
  const [showTable, setShowTable] = useState(false); 
  const [totalElements, setTotalElements] = useState(0);
  const [paginationModel, setPaginationModel] = useState({ page: 0, pageSize: 100 });

  const [openHistory, setOpenHistory] = useState(false);
  const [selectedRow, setSelectedRow] = useState(null);

  const updateFilter = (key, value) => setFilters(prev => ({ ...prev, [key]: value }));

  const fetchDifferences = useCallback(async (pageIndex) => {
    if (!filters.fromDate || !filters.toDate) {
      alert("Please select both From and To dates.");
      return;
    }

    setLoading(true);
    setShowTable(true);

    const payload = {
      fromDate: filters.fromDate,
      toDate: filters.toDate,
      glccFilter: filters.glcc || ""
    };

    try {
      // POST request with query params for pagination
      const response = await callApi(`/RS/differences?page=${pageIndex}&size=100`, payload, "POST");

      const content = response?.data?.content || response?.content || [];
      const totalElementsCount = response?.data?.totalElements || response?.totalElements || 0;
      
      if (Array.isArray(content)) {
        const mappedRows = content.map((item, index) => ({
          id: item.id || `row-${pageIndex}-${index}`,
          ERROR_DATE: item.first_ERROR_DATE || '-',
          REPORT_DATE: item.reconRunDate || '-',
          GLCC_VAL: `${item.branchCode || ''} ${item.currency || ''} ${item.cgl || ''}`,
          CBS_BALANCE: item.cbsBalance ?? 0,
          GL_BALANCE: item.glBalance ?? 0,
          DIFFERENCE_AMOUNT: item.differenceAmount ?? 0,
          DIFF_YESTERDAY: item.diffBwYesterday ?? 0,
          TYPE_VAL: item.type || '-',
          HEAD_VAL: item.head || '-',
        }));
        
        setRows(mappedRows);
        setTotalElements(totalElementsCount);
      }
    } catch (err) {
      console.error(err);
      setRows([]);
    } finally {
      setLoading(false);
    }
  }, [filters]);

  useEffect(() => {
    if (showTable) {
      fetchDifferences(paginationModel.page);
    }
  }, [paginationModel.page, fetchDifferences, showTable]);

  const columns = [
    { field: 'ERROR_DATE', headerName: 'Error Date', width: 120, headerClassName: 'super-app-theme--header' },
    { field: 'GLCC_VAL', headerName: 'GLCC (Br-Cur-CGL)', width: 220, headerClassName: 'super-app-theme--header' },
    { field: 'CBS_BALANCE', headerName: 'CBS Balance', width: 130, align: 'right', headerClassName: 'super-app-theme--header' },
    { field: 'GL_BALANCE', headerName: 'GL Balance', width: 130, align: 'right', headerClassName: 'super-app-theme--header' },
    { 
      field: 'DIFFERENCE_AMOUNT', 
      headerName: 'Difference', 
      width: 140, 
      align: 'right',
      headerClassName: 'super-app-theme--header',
      renderCell: (params) => (
        <Typography sx={{ color: params.value < 0 ? 'error.main' : 'success.main', fontWeight: 'bold', fontSize: '0.875rem' }}>
          {params.value.toLocaleString()}
        </Typography>
      )
    },
    { field: 'DIFF_YESTERDAY', headerName: 'Yesterday Diff', width: 150, align: 'right', headerClassName: 'super-app-theme--header' },
    { field: 'TYPE_VAL', headerName: 'Type', width: 120, headerClassName: 'super-app-theme--header' },
    { field: 'HEAD_VAL', headerName: 'Head', width: 130, headerClassName: 'super-app-theme--header' },
    {
      field: 'action',
      headerName: 'Action',
      width: 90,
      headerClassName: 'super-app-theme--header',
      renderCell: (params) => (
        <IconButton color="primary" onClick={() => { setSelectedRow(params.row); setOpenHistory(true); }}>
          <HistoryIcon />
        </IconButton>
      ),
    },
  ];

  return (
    <Container maxWidth="xl" sx={{ mt: 4, mb: 4 }}>
      <Box sx={{ mb: 4, display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
        <Typography variant="h4" sx={{ fontWeight: 700, color: '#1a237e' }}>
          Reconciliation Analytics
        </Typography>
      </Box>

      {/* Filter Section with Card UI */}
      <Card sx={{ borderRadius: 3, boxShadow: '0 4px 20px rgba(0,0,0,0.08)', mb: 4 }}>
        <CardContent sx={{ p: 3 }}>
          <Grid container spacing={3} alignItems="flex-end">
            <Grid item xs={12} sm={6} md={3}>
              <Typography variant="subtitle2" sx={{ mb: 1, ml: 0.5, fontWeight: 600 }}>From Date</Typography>
              <TextField 
                fullWidth type="date" size="small"
                value={filters.fromDate} onChange={(e) => updateFilter('fromDate', e.target.value)}
                InputProps={{ startAdornment: <InputAdornment position="start"><CalendarMonthIcon size="small" /></InputAdornment> }}
              />
            </Grid>
            <Grid item xs={12} sm={6} md={3}>
              <Typography variant="subtitle2" sx={{ mb: 1, ml: 0.5, fontWeight: 600 }}>To Date</Typography>
              <TextField 
                fullWidth type="date" size="small"
                value={filters.toDate} onChange={(e) => updateFilter('toDate', e.target.value)}
                InputProps={{ startAdornment: <InputAdornment position="start"><CalendarMonthIcon size="small" /></InputAdornment> }}
              />
            </Grid>
            <Grid item xs={12} md={4}>
              <Typography variant="subtitle2" sx={{ mb: 1, ml: 0.5, fontWeight: 600 }}>GLCC Search</Typography>
              <TextField 
                fullWidth size="small" placeholder="Search by Branch, Currency or CGL..."
                value={filters.glcc} onChange={(e) => updateFilter('glcc', e.target.value)}
                InputProps={{ startAdornment: <InputAdornment position="start"><SearchIcon /></InputAdornment> }}
              />
            </Grid>
            <Grid item xs={12} md={2}>
              <Button 
                fullWidth variant="contained" size="large" 
                onClick={() => { setPaginationModel({ page: 0, pageSize: 100 }); fetchDifferences(0); }}
                sx={{ height: 40, borderRadius: 2, textTransform: 'none', fontWeight: 600, boxShadow: '0 4px 12px rgba(25, 118, 210, 0.3)' }}
              >
                Search Data
              </Button>
            </Grid>
          </Grid>
        </CardContent>
      </Card>

      {/* Results Table Section */}
      {showTable && (
        <Paper sx={{ 
          height: 650, width: '100%', borderRadius: 3, overflow: 'hidden',
          boxShadow: '0 4px 24px rgba(0,0,0,0.06)', border: '1px solid #e0e0e0'
        }}>
          <DataGrid
            rows={rows}
            columns={columns}
            rowCount={totalElements}
            loading={loading}
            paginationMode="server"
            paginationModel={paginationModel}
            onPaginationModelChange={setPaginationModel}
            pageSizeOptions={[100]}
            disableSelectionOnClick
            sx={{
              border: 'none',
              '& .super-app-theme--header': { bgcolor: '#f8f9fa', color: '#5f6368', fontWeight: 700 },
              '& .MuiDataGrid-cell:hover': { color: 'primary.main' },
              '& .MuiDataGrid-row:hover': { bgcolor: '#f5faff' },
            }}
          />
        </Paper>
      )}

      {/* Enhanced History Modal */}
      <Modal open={openHistory} onClose={() => setOpenHistory(false)} closeAfterTransition>
        <Box sx={modalStyle}>
          <Box sx={{ bgcolor: '#1a237e', p: 2, color: 'white', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <Typography variant="h6">Record Details</Typography>
            <IconButton size="small" onClick={() => setOpenHistory(false)} sx={{ color: 'white' }}><CloseIcon /></IconButton>
          </Box>
          <Box sx={{ p: 3 }}>
            {selectedRow && (
              <Grid container spacing={2}>
                <Grid item xs={12}><Typography variant="caption" color="text.secondary">GLCC COMBINATION</Typography><Typography variant="body1" sx={{ fontWeight: 600 }}>{selectedRow.GLCC_VAL}</Typography><Divider sx={{ mt: 1 }} /></Grid>
                <Grid item xs={6}><Typography variant="caption" color="text.secondary">HEAD</Typography><Typography variant="body2">{selectedRow.HEAD_VAL}</Typography></Grid>
                <Grid item xs={6}><Typography variant="caption" color="text.secondary">TYPE</Typography><Typography variant="body2">{selectedRow.TYPE_VAL}</Typography></Grid>
                <Grid item xs={6}><Typography variant="caption" color="text.secondary">DIFFERENCE</Typography><Typography variant="body2" color="error.main" sx={{ fontWeight: 700 }}>{selectedRow.DIFFERENCE_AMOUNT}</Typography></Grid>
                <Grid item xs={6}><Typography variant="caption" color="text.secondary">YESTERDAY DIFF</Typography><Typography variant="body2">{selectedRow.DIFF_YESTERDAY}</Typography></Grid>
              </Grid>
            )}
            <Button sx={{ mt: 4, borderRadius: 2 }} fullWidth variant="contained" onClick={() => setOpenHistory(false)}>Close Details</Button>
          </Box>
        </Box>
      </Modal>
    </Container>
  );
};

export default BalanceRangeSearchScreen;
